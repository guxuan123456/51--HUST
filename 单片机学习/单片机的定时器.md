# 单片机的定时器

[TOC]

## 定时计数器结构和工作原理

### 基本知识

- 51系列单片机基本型片内有二个16位定时/计数器：定时器0(T0)和定时器1(T1)；增强型片内有三个十六位定时/计数器：T0 、T1、 T2 。

- 定时\计数器可由软件设置为定时工作方式或计数工作方式。

- 定时器是16位加1计数器。

  T0由2个8位特殊功能寄存器TH0和TL0构成，
  T1由2个8位特殊功能寄存TH1和TL1构成。

- T0和T1受特殊功能寄存器TMOD和TCON控制。



### 定时工作方式

- 设置为定时方式，片内振荡器经12分频产生计数脉冲
- 一个机器周期定时器(T0或T1)的数值加1直至计数满产生溢出。溢出就可能会产生中断。

### 计数工作方式

- 计数工作方式：通过引脚T0(P3．4)和T1(P3．5)对外部脉冲信号计数
- 当输入脉冲信号产生由1至0的下降沿时，定时器的值加1。CPU采样T0，T1输入电平，看是否是由高到低，是的话加一
- 由于检测一个1至0的跳变需要二个机器周期，故最高计数频率为振荡频率的二十四分之一。
- 电平保持时间至少是一个完整的机器周期。

## 定时计数器的控制寄存器

前面基础知识可知定时器共有两个控制寄存器：定时器控制TCON（88H)和
定时器工作模式寄存器TMOD(89H)。下面分别介绍：

### 工作模式寄存器TMOD(89H)

TMOD用于控制T0和T1造作模式，各位定义如下：

![1588662203484](\picture\tmod.png)

★ GATE：门控信号
	GATE=0，TRx=1时即可启动定时器工作 ；
	GATE=1， 除TRx=1 外,还需INTx=1才可启动定时器工作。
★ C/T：定时器/计数器选择位
	C/T=1，为计数器方式；
	C/T=0，为定时器方式。
★ M1 M0 工作模式选择位
	M1M0=00 工作方式0（13位方式）。
	M1M0=01 工作方式1（16位方式）。
	M1M0=10 工作方式2（8位自动再装入方式）。
	M1M0=11 工作方式3（T0为2个8位方式）。

### 控制寄存器TCON（88H）

![1588662303590](\picture\TCON.png)

## 定时器的四种工作方式

对TMOD寄存器的M1、M0位的设置，可选择四种工作方式，即方式0、方式1、方式2和方式3

- 方式0

  定时器(T0或T1)工作于13位定时、计数方式.

  这种模式下，只用13位，其中THX8位，TLX5位， TLX的高3位末用。

  TLX的低5位溢出时向THX进位,而THX溢出时硬件置位TF0，并申请中断。

  溢出与否通过查询TF0是否置位，开中断则产生溢出中断。

- 方式1

  M1M0=01时，定时计数器工作在方式1。

  模式是一个16位定时／计数方式。寄存器TH0和TL0是以全16位参与操作。

  16寄存器(THX和TLX) 中THX提供高8位、TLX提供低8位计数初值

- 方式2

  M1M0=10时，定时计数器工作在方式2。是8位的可自动重装载的定时计数方式。

  其中TL0用作8位计数器， TH0用以保持计数初值。当TL0计数溢出，置位TF0，TH0中的初值自动装入TL0，继续计数，循环重复计数。相当于一个用来存起始数字。

  2^8＝256(个外部脉冲),可产生精确的定时时间。

- 方式3

  TL0和TH0被分成为两个互相独立的8位计数器。

  TL0可工作为定时方式或计数方式。TH0只可用作定时功能。

  定时器T1无模式 3, 可工作于方式0、1、2，但不能使用中断方式。

上面的东西看着感觉有点绕，感觉说的不清楚。

## 定时计数器的应用编程

### 定时器计数初值C的计算和装入

- 计数方式

  计数初值 C=模-X（其中X为要计的脉冲个数）

- 定时方式

  计数初值 C=模－t / MC

  其中t为预定时时间，MC为机器周期。

  比如：当采用12MHZ晶振时，MC=1μs 当采用6MHZ晶振时，MC=2μs。

举个例子：要计100个脉冲的计数初值

- 方式0（ 13位方式）:
  C==2000H－64H=1F9CH＝0001 1111 1001 1100B
  把13位中的高八位1111 1100B装入TH0，而把13位中的低五位xxx1 1100B装入TL0。
  MOV TH0，#0FCH； MOV TL0，#1CH；(xxx用“0”填入)
- 方式1(16位方式):
  C==10000H-64H=FF9CH 用指令装入计数初值：
  MOV TH0，#0FFH； MOV TL0，#9CH
- 方式2（8位自动再装入方式）
  C==100H－64H=9CH 初值既要装入TH0，也要装入TL0。
  MOV TH0，#9CH； MOV TL0，#9CH

### 定时计数器的初始化编程

初始化编程步骤：

1）根据定时时间要求或计数要求计算计数器初值；
2）工作方式控制字送TMOD寄存器；
3）送计数初值的高八位和低八位到THX和TLX寄存 器中；
4）启动定时（或计数），即将TRX置位。

如果工作于中断方式，需要置位EA（中断总开关）及ETX（允许定时/计数器中断）。并编中断服务程序。

**再举个例子**

八个发光二极管，轮流点亮，每个管亮100ms，晶振为6MHz。

解：	MC=2μs
			计数值=100ms/2μs =50000=C350H
			初值=10000H-C350H=3CB0H

1、不采用中断方式，计数方式汇编程序：

```
ORG 0030H
MOV A，#01H：置第一个LED亮
NEXT：MOV P1，A MOV TMOD，#10H ；T1工作于定时方式1
MOV TH1，#3CH
MOV TL1，#0B0H； 定时100ms
SETB TR1
AGAI: JBC TF1,SHI； 100ms到转SHI,并清TF1
SJMP AGAI
SHI： RL A
SJMP NEXT
```

2、中断方式

```
    ORG 0000H
    AJMP MAIN ；单片机从0000H开始执行
    ORG 001BH
    AJMP IV1 ；转移到IV1
    ORG 0030H ；主程序

MAIN：MOV A，#01H
    MOV P1，A ；置第一个LED亮
    MOV TMOD，#10H ；T1定时方式1
    MOV TH1，#3CH
    MOV TL1，#0B0H ；定时100ms
    SETB TR1 ；启动T1工作
    SETB ET1 ；允许T1中断
    SETB EA ；允许总中断

WAIT：SJMP WAIT ；等待中断

IV1：RL A ；中断程序，左移一位
    MOV P1，A ；下一个二极管亮
    MOV TH1，#3CH
    MOV TL1，#0B0H ；重装初值
    RETI ；中断返回
```

**再举个例子**

在P1.7端接一个发光二极管LED，要求利用定时控制使LED亮一秒灭一秒周而复始，设fosc=6MHz。

分析： T0定时100ms初值=100×103/2=50000，即初值为-50000。T1计数5个脉冲工作于方式2，计数初值为-5，T0和T1均采用中断方式。程序如下：

```
#include 〈reg51.h〉
sbit P1_0=P1^0；
sbit P1_7=P1^7；

timer0( ) interrupt 1 using 1 /* T0中断服务程序 */
｛ P1_0=! P1_0； /* 100ms到P1.0反相*/
TH0=-50000/256； /* 重载计数初值 */
TL0=-50000%256；
｝

timerl() interrupt 3 using 2 /* T1中断服务程序 */
｛ P1_7=! P1_7； /* 1s到，灯改变状态 */
｝

main ()｛
P1_7=0； /* 置灯初始灭 */
P1_0=1； /* 保证第一次反相便开始计数 */
TMOD=0x61； /* T0方式 1 定时，T1方式 2 计数 */
TH0=-50000/256； /* 预置计数初值 */
TL0=-50000%256；
TH1=-5；
TL1=-5；
IP=0x08； /* 置优先级寄存器 */
EA=1；ET0=1；ET1=1； /* 开中断 */
TR0=1；TR1=1； /* 启动定时/计数器 */
for(;;)｛;｝ /* 等待中断 */
}
```

 例5-３ 有P3.4引脚(T0)输入一低频信号(其小于0.5kHZ),要求P3.4每发生一次负跳变时， P1.0输出一个500us同步负脉冲，同时P1.1输出一个1ms的同步正脉冲。已知晶振频率为6MHZ。

![1588678553969](C:\Users\lenovo\Desktop\单片机\单片机学习\picture\5-3.png)

初态P1.0输出高电平(系统复位时实现),P1.1输出低电平，T0选方式２计数方式(计一个脉冲，初值为FFH)。当加在P3.4上的外部脉冲负跳变时，T0加1，计数器溢出，程序查询到TF0为1，改变T0为500us定时工作方式，并使P1.0输出０，P1.1输出１。T0第一次定时500us溢出后，P1.0恢复１，T0第二次定时500us溢出后，P1.1恢复０，T0恢复外部脉冲计数。

设定时500us的初始值为X，则：
(256－X)×2×10－6 = 500×10-6
解得 X=6

```
BEGIN:MOV TMOD,#6H ; 设T0为方式２外部计数
MOV TH0,#0FFH ；计数一个脉冲
MOV TL0,#0FFH
CLR P1.1 ；P1.1初值为0
SETB TR0 ；启动计数器
DELL: JBC TF0,RESP1 ；检测外跳变信号
AJMP DELL
RESP1:CLR TR0
MOV TMOD,#02H；重置T0为500ms定时

MOV TH0,#06H ；重置定时初值
MOV TL0,#06H
SETB P1.1 ; P1.1置1
CLR P1.0 ; P1.0清0
SETB TR0 ; 启动定时计数器
DEL2: JBC TF0, RESP2 ；检测第一次500us到否
AJMP DEL2
RESP: SETB P1.0 ；P1.0恢复1
DEL3: JBC TF0,RESP3 ；检测第二次500us到否
AJMP DEL3
RESP3: CLR P1.1 ； P1.1复0
CLR TR0
AJMP BEGIN
```

### 门控位的应用

门控位GATE为1时，TRx=1，INTx=1才能启动定时器。利用这个特性可
以测量外部输入脉冲的宽度。

**举个例子**

例7-4 利用T0门控位测试 INT0引脚上出现的正脉冲宽度，已知晶振频率为12MHz，将所测得值最高位存入片内71H单元，低位存入70H单元。

解：设外部脉冲 由(P3.2)输入，T0工作于定时方式 1(16位计数)，GATE设为1。测试时，应在INT0 低电平时，设置TR0为1(16位计数)；当INT0 变为高电平时，就启动计数； 再次变低时，停止计数。此计数值与机器周期的乘积即为被测正脉冲的宽度。因fosc=12MHZ，机器周期为1us，测试过程如下。

```
MOV TMOD，#09H ; 设T0为方式1
MOV TL0，#00H ；设计初值取最大值
MOV TH0，#00H
MOV R0，#70H
JB P3.2, $ ；等P3.2(INT0 )变低
SETB TR0 ；启动T0准备工作
JNB P3.2, $ ；等待P3.2(INT0 )
JB P3.2,$ ; 等待P3.2(INT0 )
CLR TR0 ;停止计数
MOV @R0,TL0 ；存放结果
INC R0
MOV @R0,TH0
SJMP $
```

## 小结

![1588679079468](\picture\小结.png)

- 定时和计数实质都是对脉冲的计数，只是被计脉冲的来源不同，定时方式的被计脉冲来源于时钟，计数方式的被计脉冲来源于外部，定时方式的计数初值和被计脉冲周期有关，计数方式的和被计脉冲的个数有关。
- 无论定时还是计数，当计满规定的 脉冲个数产生溢出（计数初值寄存器回零），置位TFx , 可以通过程序查询，如果允许中断，会产生中断。
- 最后，计时器和计数器一般和中断一块考虑比较好，这一点自己需要记住那几个管脚，就是上面图表中给的，记住之后再用定时器就超级简单了，再结合中断刘辟的一批。
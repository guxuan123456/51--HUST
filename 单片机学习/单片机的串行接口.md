# 单片机的串行接口

[TOC]

## 概述

单片机在工业控制时，现场数据采用串行通信方式发往主机进行处理，以降低通信成本，提高通信可靠性。

51系列单片机内有一个全双工的异步通信接口，通过对串行接口写控制字可以选择其数据格 式，同时内部有波特率发生器，提供可选的波特率，可完成双机通信或多机通信。

#### 串行通信的分类

同步串行通信(速度快，可以连续发送n个数据)、异步串行通信(速度慢，结构简单)。

单工、半双工、全双工。

#### 串行接口的基本任务

1. 数据格式化
2. 串并转换
3. 控制数据传输速率
4. 进行传送错误检测，(自动生成校验位和校验码)

#### 波特率

这个主要是控制数据传输速率，往往通过定时器来实现

#### 串行通信总线标准和接口

##### 通信线连接

不同的通信距离，串行通信电路有不同的连接方法。

##### 串行通信接口总线标准

异步串通，标准有三种(具体介绍见PPT，感觉不太行)

## 单片机串行口的结构和工作原理

51单片机有一个可编程的全双工异串行通信接口，它可作UART用，也可作同步移位寄存器，其帧格式可有8位、10位或l l位，并能设置各种波特率，给使用者带来很大的灵活性。

#### 串行口的内部结构

![1589792793797](\picture\1589792793797.png)

看上面的图可以发现：

- 两个物理上独立的接收、发送缓冲器SBUF，它们占用同一地址99H，可同时发送、接收数据。

  1.  发送缓冲器只能写入，不能读出，CPU写SBUF，一方面修改发送寄存器，同时启动数据串行发送
  2. 接收缓冲器只能读出、不能写入。读SBUF，就是读接收寄存器。

- #### 串行控制寄存器SCON。用以存 放串行口的控制和状态信息。

- 特 殊功能寄存器PCON的最高位SMOD为串行口波特率的倍增控制位。

- 波特率发生器

  1. 定时器T1作波特率发生器--可变波特率
  2. 以内部时钟的分频器作波特率发生器---固定波特率

## 串行口的控制寄存器

对串行口的控制只需用两个控制字分别写入特殊功能寄存器。

串行口控制寄存器SCON(98H)
电源控制寄存器PCON(97H)

#### 串行口控制寄存器SCON(98H)

![1589793222361](\picture\1589793222361.png)

- SM0 SM1:串行口工作方式控制位。
  	0 0---方式0, 	0 1---方式1
  	1 0---方式2, 	1 1---方式3
- REN：串行接收允许位。
      0---禁止接收,      1---允许接收
- TB8:    在方式2,3中, TB8是发送机要发送的第9位数据。
- RB8:    在方式2,3中, RB8是接受机收到的第9位数据,该数据来自发送机的TB8。
- TI: 发送中断标志位。发送前必须用软件清零，发送完一帧数据后，由硬件置 “1”，如果再发送,必须用软件再清零。
- RI: 接收中断标志位。接收前,必须用软件清零, 接收完一帧数据后由片内硬件自动置“1”。如果再接收必须用软件清零。
- SM2:多机通信控制位，仅用于方式2和方式3。(感觉一般不用吧)

#### 电源控制寄存器PCON(97H)

![1589793453490](\picture\1589793453490.png)

- SMOD :  波特率加倍位。在计算串行方式 1、 2、 3 的波特率时 

  ​                SMOD＝ 0—不加倍;	 SMOD＝ 1— 加倍

## 串行口的工作方式

1. 方式0
   - 数据格式为8位,低位在前,高位在后。
   - RXD为串行数据的发送端或接收端, TXD输出频率为 fosc/12的时钟脉冲。波特率固定为fosc/12 (fosc为单片机晶振频率)
2. 方式1
   - 为10位异步通信方式,几每帧数据由1个起始位“0”.八个数据位 和1个停止位“1”共10位构成.其中起始位和停止位在发送时是自动插入的.
   - 以TXD为串行数据的发送端,T1提供位时钟,RXD为数据的接收端,由T1提供移位时钟,是波特率可变方式
   - 波特率=(2SMOD/32)×(TI的溢出率)=(2SMOD/32)×(fosc/12(256-x) )
     根据给定的波特率,可以计算T1的计数初值X。
3. 方式2
   - 11位异步发送/接收方式,即每帧数据由有一个起始位“0”,9个数据位和1个停止位“1”组成.发送时第九个数据位,由SCON寄存器的TB8位 提供,接收到的第九位数据存放在SCON寄存器的RB8位.
   - 第九位数据可作为检验位,也可用于多机通信中识别传送的是地址还是数据的特征位。
   - 波特率固定为(2SMOD/64)×fosc.
4. 方式3
   - 数据格式同方式 2，所不同的是波特率可变，计算方式同方式 1。

![1589793986534](\picture\1589793986534.png)



## 串行口应用编程

- 波特率两种方式
  1. 固定波特率
  2. 可变波特率
- 串行通信编程方式
  - 查询方式：查RI 或者TI是否为“1”。
  - 中断方式：如果预先开了中断，当TI、RI 为“1”，会自动产生中断。



#### 举个例子

1.  接线如图，编一个自发自收程序，检查单片机的串行口是否完好，f=12MHz，波特率＝600，取SMOD＝0。

![1589794187801](\picture\1589794187801.png)

```
MOV TMOD，#20H
MOV TH1, #0CCH
MOV TL1, #0CCH ; 设定波特率
SETB TR1
MOV SCON, #50H
ABC: CLR TI
MOV P1, #0FEH ; LED灭
ACALL DAY ; 延时
MOV A, #OFFH
MOV SBUF, A ; 发送数据FFH
JNB RI, $ ;RI = 1等待
CLR RI
MOV A, SBUF ; 接收数据，A=FFH
MOV P1, A ; 灯亮
JNB TI, $ ;TI = 1等待
ACALL DAY ; 延时
SJMP ABC
DAY: MOV R0, #0
DAL: MOV R1, #0
DJNZ R1, $
DJNZ R0, DAL
RET
//如果发送接收正确，可观察到P1.0接的发光二极管闪亮。
```

1. 在内部数据存贮器20H～3FH单元中共有32个数据，要求采用方式1串行发送出去， 传送速率为1200波特，设fosc＝12MHZ。
   方法：T1工作于方式 2 作波特率发生器，取SMOD＝0，T1的时间常数计算如下：
   波特率＝（2SMOD/32）×fosc/（12×(256-x)）
   1200＝（1/32）×(12×106) )/ (12×(256-x)
   x＝230＝E6H

​       

```
发送程序：
#include<reg51.h>
main( )
{
unsingned char i;
char *p;
TMOD=0x20;
TH1=0xe6;TL1=0xe6;
TR1=1;
SCON=0x40;
p=0x20;
for (i=0;i<=32;i++){
SBUF=*p;
p++;
while (!TI);
TI=0;
}
}
接收程序：
#include <reg51.h>
main( )
{ unsingned char I,*p;
TMOD=0x20;TH1=0xe6;TL1=0xe6;
TR1=1;
SCON=0x50;p=0x20;
for (i=0;i<=32;i++){
while(!RI);
RI=0; *p=SBUF;
p++; ｝｝
```

3. 例如串行通信方式0，扩展I/O接口，接八个数码管，使内部数据存储器58H～-5FH单元的内容为0XH。

   由于TXD，RXD运行在工作方式0时，可方便的连接串入并移出位寄存器        74LS164，TXD发送移位脉冲，RXD发送数据，P3.3用于显示器的输入控制，通过74LS164接八个数码管，电路如下图所示。

   ```
   ORG 0050H
   SETB P3.3 ; 允许移位寄存器工作
   MOV SCON, #0 ; 选串行通信方式0
   MOV R7, #08H ; 显示八个字符
   MOV R0, #5FH ; 先送最后一个显示字符
   MOV DPTR, #TBA ; DPTR指向字形表首址
   DLO: MOV A, @R0 ; 取待显示数码
   MOVC A,@A+DPTR ; 查字形表
   MOV SBUF, A ; 送出显示
   JNB TI, $ ; 一帧输出完？
   CLR TI ; 已完，清中断标志
   DEC R0 ; 修改显示数据地址
   DJZN R7, DLO
   CLR P3.3 ; 8位送完，关发送脉冲
   SJMP $ 
   TBA: DB 0C0H,0F9H,0A4H,B0H,99H,92H DB 82H,0F8H,80H,90H,83H,83H,0C6H
   DB 0A1H,86H,84H,0FFH,0BFH
   END
   ```

   